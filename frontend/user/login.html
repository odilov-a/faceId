<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Login - FaceID System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../assets/css/main.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid vh-100 d-flex align-items-center justify-content-center bg-gradient">
        <div class="row w-100">
            <div class="col-md-8 col-lg-6 mx-auto">
                <div class="card auth-card shadow-lg">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <div class="auth-icon mb-3">
                                <i class="fas fa-camera fa-3x text-success"></i>
                            </div>
                            <h2 class="card-title">Face ID Login</h2>
                            <p class="text-muted">Look directly at the camera to authenticate</p>
                        </div>

                        <div id="alertContainer"></div>

                        <div class="row">
                            <div class="col-md-8 mx-auto">
                                <!-- Camera Preview -->
                                <div id="cameraContainer" class="mb-4">
                                    <div class="camera-container">
                                        <div id="cameraPreview" class="text-center p-5 bg-dark rounded">
                                            <i class="fas fa-camera fa-4x text-white-50 mb-3"></i>
                                            <div class="text-white">Click "Start Camera" to begin</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Camera Controls -->
                                <div class="text-center mb-4">
                                    <button class="btn btn-success btn-lg me-2" onclick="startCamera()" id="startBtn">
                                        <i class="fas fa-camera me-2"></i>Start Camera
                                    </button>
                                    <button class="btn btn-primary btn-lg me-2" onclick="authenticateWithFace()" disabled id="loginBtn">
                                        <i class="fas fa-sign-in-alt me-2"></i>Login with Face
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="stopCamera()" disabled id="stopBtn">
                                        <i class="fas fa-stop me-2"></i>Stop
                                    </button>
                                </div>

                                <!-- Instructions -->
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-2"></i>Instructions:</h6>
                                    <ol class="mb-0 small">
                                        <li>Click "Start Camera" to activate your webcam</li>
                                        <li>Position your face within the circle overlay</li>
                                        <li>Look directly at the camera</li>
                                        <li>Click "Login with Face" to authenticate</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <a href="../index.html" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Home
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-5">
                    <div class="mb-4">
                        <i class="fas fa-check-circle fa-4x text-success"></i>
                    </div>
                    <h4 class="mb-3">Login Successful!</h4>
                    <p class="text-muted mb-4">Welcome back, <span id="welcomeUser"></span>!</p>
                    <p class="small text-muted">Redirecting to dashboard...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/face-capture.js"></script>
    <script>
        let faceCapture = null;
        
        // Initialize camera when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check if already logged in
            if (Utils.isAuthenticated()) {
                const userInfo = Utils.getUserInfo();
                if (userInfo && userInfo.role === 'user') {
                    window.location.href = 'dashboard.html';
                }
            }
        });

        // Start camera
        async function startCamera() {
            try {
                FaceUtils.showCameraPreview('cameraPreview');
                faceCapture = await FaceUtils.initFaceCapture();
                
                // Update UI
                document.getElementById('startBtn').disabled = true;
                document.getElementById('loginBtn').disabled = false;
                document.getElementById('stopBtn').disabled = false;
                
                Utils.showAlert('Camera started! Position your face in the camera.', 'info');
            } catch (error) {
                Utils.showAlert('Camera error: ' + error.message, 'danger');
            }
        }

        // Stop camera
        function stopCamera() {
            if (faceCapture) {
                faceCapture.stopCamera();
                faceCapture = null;
            }
            
            // Reset UI
            document.getElementById('cameraPreview').innerHTML = `
                <i class="fas fa-camera fa-4x text-white-50 mb-3"></i>
                <div class="text-white">Click "Start Camera" to begin</div>
            `;
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('loginBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
        }

        // Authenticate with face
        async function authenticateWithFace() {
            if (!faceCapture) {
                Utils.showAlert('Please start the camera first', 'warning');
                return;
            }

            Utils.showLoading('Analyzing face...');

            try {
                // Capture face
                const result = await FaceUtils.captureFace(faceCapture, 5, 120, { debug: false });
                
                // Authenticate with backend using multi-embedding array
                const response = await api.userLogin(result.embeddings);
                
                // Store authentication data
                api.setAuthToken(response.token);
                localStorage.setItem('userInfo', JSON.stringify(response.data));
                localStorage.setItem('userRole', 'user');
                
                Utils.hideLoading();
                
                // Show success modal
                document.getElementById('welcomeUser').textContent = 
                    `${response.data.firstName} ${response.data.lastName}`;
                
                const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();
                
                // Stop camera
                stopCamera();
                
                // Redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 3000);
                
            } catch (error) {
                Utils.hideLoading();
                
                if (error.message.includes('not recognized')) {
                    Utils.showAlert('Face not recognized. Please ensure you are registered in the system.', 'warning');
                } else {
                    Utils.showAlert('Authentication failed: ' + error.message, 'danger');
                }
            }
        }

        // Handle page cleanup
        window.addEventListener('beforeunload', function() {
            if (faceCapture) {
                faceCapture.stopCamera();
            }
        });
    </script>
</body>
</html>
